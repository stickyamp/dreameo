<ion-content
  [scrollEvents]="false"
  scrollY="true"
  [fullscreen]="true"
  class="calendar-container"
>
  <!-- Calendar Section -->
  <div class="calendar-section">
    <!-- Month Navigation -->
    <div class="month-navigation">
      <ion-button fill="clear" class="month-nav-btn" (click)="previousMonth()">
        <ion-icon name="chevron-back" slot="icon-only"></ion-icon>
      </ion-button>
      <h3 class="month-label">{{ getMonthYearLabel() }}</h3>
      <ion-button fill="clear" class="month-nav-btn" (click)="nextMonth()">
        <ion-icon name="chevron-forward" slot="icon-only"></ion-icon>
      </ion-button>
    </div>

    <!-- Calendar Grid -->
    <div class="calendar-grid">
      <!-- Weekday Headers -->
      <div class="weekday-headers">
        <div class="weekday" *ngFor="let day of daysOfWeek">{{ day }}</div>
      </div>

      <!-- Calendar Days -->
      <div class="calendar-days">
        <div
          class="calendar-day"
          *ngFor="let day of calendarDays; trackBy: trackByDay"
          [class.current-month]="day.currentMonth"
          [class.selected]="isSelected(day.date)"
          [class.today]="isToday(day.date)"
          [class.has-dreams]="hasDreams(day.date)"
          (click)="selectDay(day)"
        >
          <span class="day-number">{{ day.day }}</span>
          <span class="dream-indicator" *ngIf="hasDreams(day.date)"></span>
        </div>
      </div>
    </div>
  </div>

  <!-- Bloque: Dream Journey Map (Mapa constelación) -->
  <div
    class="dream-map-container"
    style="
      background: var(--color-surface);

      box-shadow: var(--shadow-elevation);
    "
  >
    <div class="dream-map-header">
      {{ "CALENDAR.DREAM_JOURNEY_MAP_TITLE" | translate }}
    </div>
    <div class="dream-constellation-background">
      <svg
        viewBox="0 0 350 120"
        class="dream-constellation-svg"
        preserveAspectRatio="xMidYMid meet"
      >
        <!-- Partículas de fondo: mezcla de puntos y pequeñas cruz -->
        <ng-container *ngFor="let s of bgStars; let idx = index">
          <ng-container *ngIf="idx % 3 !== 0">
            <circle
              [attr.cx]="s.x"
              [attr.cy]="s.y"
              [attr.r]="s.r"
              fill="var(--color-accent-hover)"
              fill-opacity="0.16"
            />
          </ng-container>
          <ng-container *ngIf="idx % 3 === 0">
            <g
              [attr.transform]="
                'translate(' +
                s.x +
                ',' +
                s.y +
                ') scale(' +
                (s.r / 2 + 0.6) +
                ')'
              "
            >
              <path
                d="M0,-2 L0,2 M-2,0 L2,0"
                stroke="var(--color-active)"
                stroke-width="0.7"
                stroke-linecap="round"
                opacity="0.28"
              />
            </g>
          </ng-container>
        </ng-container>
        <!-- Conexiones solo si hay sueños -->
        <polyline
          *ngIf="dreamDayPoints.length > 1"
          [attr.points]="polylineString"
          style="
            fill: none;
            stroke: var(--color-accent);
            stroke-width: 1.2;
            opacity: 0.8;
            filter: url(#glow2);
          "
        ></polyline>
        <!-- Estrellas de constelación (svg path nuevo) solo si hay sueños -->
        <ng-container *ngIf="dreamDayPoints.length > 0">
          <ng-container *ngFor="let pt of dreamDayPoints">
            <!-- Centramos el path original (viewBox ~12800x11810) con translate(-6400,-5905) y lo reducimos con scale -->
            <g
              [attr.transform]="
                'translate(' +
                pt.x +
                ',' +
                pt.y +
                ') scale(0.0011) translate(-6400,-5905)'
              "
            >
              <path
                d="M6327 11292 c-60 -180 -161 -489 -227 -687 -65 -198 -233 -709 -373 -1135 -141 -426 -367 -1114 -503 -1527 l-248 -753 -2358 0 c-1297 0 -2358 -3 -2358 -7 0 -5 170 -130 378 -279 207 -149 1057 -758 1887 -1353 831 -596 1518 -1091 1528 -1100 20 -19 55 94 -420 -1346 -187 -570 -344 -1047 -628 -1910 -141 -429 -286 -869 -322 -978 -36 -109 -63 -201 -60 -204 7 -6 -236 -180 1912 1362 1012 726 1855 1331 1872 1343 l33 23 762 -548 c2447 -1758 3053 -2191 3056 -2188 2 2 -46 153 -106 337 -61 183 -216 655 -346 1048 -511 1556 -712 2168 -811 2470 -145 440 -185 563 -185 575 0 6 855 623 1900 1373 1045 750 1900 1368 1900 1373 0 5 -909 10 -2357 11 l-2356 3 -164 500 c-90 275 -272 826 -403 1225 -131 399 -383 1166 -560 1705 -177 539 -325 983 -329 987 -4 5 -55 -139 -114 -320z"
                fill="var(--color-accent)"
                stroke="#ffffff"
                stroke-width="9"
                opacity="0.96"
                filter="url(#glow)"
              />
            </g>
          </ng-container>
        </ng-container>
        <defs>
          <filter id="glow" x="-80%" y="-80%" width="260%" height="260%">
            <feGaussianBlur stdDeviation="4" result="glow" />
            <feMerge>
              <feMergeNode in="glow" />
              <feMergeNode in="SourceGraphic" />
            </feMerge>
          </filter>
          <filter id="glow2" x="-50%" y="-50%" width="160%" height="160%">
            <feGaussianBlur stdDeviation="1.5" result="glow2" />
            <feMerge>
              <feMergeNode in="glow2" />
              <feMergeNode in="SourceGraphic" />
            </feMerge>
          </filter>
        </defs>
      </svg>
      <div *ngIf="dreamDayPoints.length === 0" class="constellation-empty-hint">
        <span>{{ "CALENDAR.NO_DREAMS_THIS_MONTH" | translate }}</span>
      </div>
    </div>
  </div>

  <!-- Bloque: Progreso mensual/rango-nivel -->
  <div class="dream-progress-container">
    <div class="dream-progress-content">
      <!-- Rank a la izquierda -->
      <div class="progress-rank-block">
        <ion-icon name="shield-outline" class="progress-rank-icon"></ion-icon>
        <div class="rank-label">{{ userRankLabel | translate }}</div>
      </div>
      <!-- Barra de progreso -->
      <div class="progress-bar-block">
        <div class="progress-bar-bg">
          <div
            class="progress-bar-fill"
            [style.width.%]="progressPercent"
          ></div>
        </div>
        <div class="progress-hint">
          {{ "CALENDAR.KEEP_GOING" | translate }}
        </div>
      </div>
      <!-- Progreso/cantidad a la derecha -->
      <div class="progress-count-block">
        <span class="progress-count"
          >{{ filledDays }}/{{ totalMonthDays }}</span
        >
        <span class="progress-count-label">{{
          "CALENDAR.DREAMS" | translate
        }}</span>
      </div>
    </div>
  </div>

  <!-- Modal for dreams list -->
  <div
    id="add-dream-modal"
    #modalOpener="appShowDreamsList"
    appShowDreamsList
  ></div>
</ion-content>
