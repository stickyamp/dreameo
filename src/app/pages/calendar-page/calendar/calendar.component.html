<ion-content
  [scrollEvents]="false"
  scrollY="true"
  [fullscreen]="true"
  class="calendar-container"
>
  <!-- Calendar Section -->
  <div class="calendar-section">
    <!-- Month Navigation -->
    <div class="month-navigation">
      <ion-button fill="clear" class="month-nav-btn" (click)="previousMonth()">
        <ion-icon name="chevron-back" slot="icon-only"></ion-icon>
      </ion-button>
      <h3 class="month-label">{{ getMonthYearLabel() }}</h3>
      <ion-button fill="clear" class="month-nav-btn" (click)="nextMonth()">
        <ion-icon name="chevron-forward" slot="icon-only"></ion-icon>
      </ion-button>
    </div>

    <!-- Calendar Grid -->
    <div class="calendar-grid">
      <!-- Weekday Headers -->
      <div class="weekday-headers">
        <div class="weekday" *ngFor="let day of daysOfWeek">{{ day }}</div>
      </div>

      <!-- Calendar Days -->
      <div class="calendar-days">
        <div
          class="calendar-day"
          *ngFor="let day of calendarDays; trackBy: trackByDay"
          [class.current-month]="day.currentMonth"
          [class.selected]="isSelected(day.date)"
          [class.today]="isToday(day.date)"
          [class.has-dreams]="hasDreams(day.date)"
          (click)="selectDay(day)"
        >
          <span class="day-number">{{ day.day }}</span>
          <span class="dream-indicator" *ngIf="hasDreams(day.date)"></span>
        </div>
      </div>
    </div>
  </div>

  <!-- Bloque: Dream Journey Map (Mapa constelación) -->
  <div
    class="dream-map-container"
    style="
      background: var(--color-surface);

      box-shadow: var(--shadow-elevation);
    "
  >
    <div class="dream-map-header">
      {{ "CALENDAR.DREAM_JOURNEY_MAP_TITLE" | translate }}
    </div>
    <div class="dream-constellation-background">
      <svg
        viewBox="0 0 350 130"
        class="dream-constellation-svg"
        preserveAspectRatio="none"
      >
        <!-- Definir filtros para efectos de brillo suave -->
        <defs>
          <filter id="starGlow" x="-50%" y="-50%" width="200%" height="200%">
            <feGaussianBlur stdDeviation="2" result="coloredBlur" />
            <feMerge>
              <feMergeNode in="coloredBlur" />
              <feMergeNode in="SourceGraphic" />
            </feMerge>
          </filter>
          <filter
            id="smallStarGlow"
            x="-50%"
            y="-50%"
            width="200%"
            height="200%"
          >
            <feGaussianBlur stdDeviation="1" result="coloredBlur" />
            <feMerge>
              <feMergeNode in="coloredBlur" />
              <feMergeNode in="SourceGraphic" />
            </feMerge>
          </filter>

          <!-- Gradiente radial para efecto de estrella más sutil -->
          <radialGradient id="starGradient" cx="50%" cy="50%" r="50%">
            <stop offset="0%" style="stop-color: #ffffff; stop-opacity: 1" />
            <stop
              offset="100%"
              style="stop-color: #ffffff; stop-opacity: 0.9"
            />
          </radialGradient>

          <radialGradient id="smallStarGradient" cx="50%" cy="50%" r="50%">
            <stop offset="0%" style="stop-color: #ffffff; stop-opacity: 0.7" />
            <stop
              offset="100%"
              style="stop-color: #ffffff; stop-opacity: 0.5"
            />
          </radialGradient>
        </defs>

        <!-- Estrellas de fondo pequeñas -->
        <ng-container *ngFor="let s of bgStars; let i = index">
          <!-- Intercalar estrellas y círculos -->
          <path
            *ngIf="i % 3 !== 0"
            [attr.d]="getSmallStarPath(s.x, s.y, s.r)"
            fill="url(#smallStarGradient)"
            filter="url(#smallStarGlow)"
            class="small-star"
          />
          <circle
            *ngIf="i % 3 === 0"
            [attr.cx]="s.x"
            [attr.cy]="s.y"
            [attr.r]="s.r * 0.8"
            fill="url(#smallStarGradient)"
            filter="url(#smallStarGlow)"
            class="small-star"
          />
        </ng-container>

        <!-- Líneas de conexión punteadas más sutiles -->
        <polyline
          *ngIf="dreamDayPoints.length > 1"
          [attr.points]="polylineString"
          fill="none"
          stroke="#ffffff"
          stroke-width="1"
          stroke-dasharray="2,4"
          opacity="0.4"
        />

        <!-- Estrellas principales conectadas -->
        <ng-container *ngIf="dreamDayPoints.length > 0">
          <ng-container *ngFor="let pt of dreamDayPoints">
            <path
              [attr.d]="getMainStarPath(pt.x, pt.y)"
              fill="url(#starGradient)"
              filter="url(#starGlow)"
              class="main-star"
            />
          </ng-container>
        </ng-container>

        <!-- Estrellas principales aisladas (sin conexión) -->
        <ng-container *ngIf="isolatedDreamPoints.length > 0">
          <ng-container *ngFor="let pt of isolatedDreamPoints">
            <path
              [attr.d]="getMainStarPath(pt.x, pt.y)"
              fill="url(#starGradient)"
              filter="url(#starGlow)"
              class="main-star isolated-star"
            />
          </ng-container>
        </ng-container>
      </svg>
    </div>
    <div
      *ngIf="dreamDayPoints.length === 0"
      class="constellation-empty-message"
    >
      <span>{{ "CALENDAR.NO_DREAMS_THIS_MONTH" | translate }}</span>
    </div>
  </div>

  <!-- Bloque: Progreso mensual/rango-nivel -->
  <div class="dream-progress-row">
    <!-- Card pequeña (badge) -->
    <div class="progress-badge-card">
      <div class="progress-rank-badge">
        @if(!currentRank.icon.includes("assets")){
        <div class="rank-icon-container">
          @if(currentRank.iconBackground){
          <ion-icon
            [name]="currentRank.iconBackground"
            [class]="currentRank.iconBackgroundCss"
          ></ion-icon>
          } @if(currentRank.icon){
          <ion-icon
            [name]="currentRank.icon"
            [class]="currentRank.iconCss"
          ></ion-icon>
          }
        </div>

        }@else {
        <img src="assets/svgs/moon-rank.svg" width="40" height="40" alt="" />
        }
        <div class="rank-name-main">{{ currentRank.title | translate }}</div>
      </div>
    </div>

    <!-- Card grande (progreso) -->
    <div class="progress-main-card">
      <div class="progress-section-right">
        <div class="progress-title-row">
          <span class="progress-title"
            >{{ "CALENDAR.PROGRESS_TO" | translate }}
            {{ nextRank?.title | translate }}</span
          >
        </div>
        <div class="progress-bar-container">
          <div class="progress-bar-track">
            <div
              class="progress-bar-fill-glow"
              [style.width.%]="progressToNextPercent"
            ></div>
          </div>
        </div>
        <div class="progress-bottom-row">
          <div class="progress-encouragement">
            {{ "CALENDAR.KEEP_GOING" | translate }}
          </div>
          <div class="progress-count-text-right">
            {{ currentDreamsCount }}/{{ nextRank?.requiredDreams }}
            {{ "CALENDAR.DREAMS" | translate }}
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal for dreams list -->
  <div
    id="add-dream-modal"
    #modalOpener="appShowDreamsList"
    appShowDreamsList
  ></div>
</ion-content>
